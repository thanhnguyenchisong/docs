// ==============================================================================
// Jenkins Pipeline Configuration - Production Ready cho Spring Boot Application
// ==============================================================================
// File n√†y ƒë·ªãnh nghƒ©a Declarative Pipeline cho ·ª©ng d·ª•ng bottleneck-resolve
// Pipeline bao g·ªìm: build, test, security scan, Docker build, v√† deployment
// ==============================================================================

@Library('shared-lib@main') _  // Optional: Load shared library n·∫øu c√≥

pipeline {
    // --------------------------------------------------------------------------
    // 1. AGENT CONFIGURATION
    // --------------------------------------------------------------------------
    // ƒê·ªãnh nghƒ©a agent ƒë·ªÉ ch·∫°y pipeline
    // C√≥ th·ªÉ override ·ªü t·ª´ng stage n·∫øu c·∫ßn
    agent {
        // S·ª≠ d·ª•ng Docker agent v·ªõi Maven image
        docker {
            image 'maven:3.9-eclipse-temurin-21-jammy'
            args '-v /root/.m2:/root/.m2 -v /var/run/docker.sock:/var/run/docker.sock'
            // Mount Maven cache ƒë·ªÉ tƒÉng t·ªëc build
            // Mount Docker socket ƒë·ªÉ build Docker images
        }
    }

    // --------------------------------------------------------------------------
    // 2. OPTIONS - Pipeline-level options
    // --------------------------------------------------------------------------
    options {
        // Gi·ªØ build history (t·ªëi ƒëa 50 builds)
        buildDiscarder(logRotator(
            numToKeepStr: '50',
            daysToKeepStr: '30',
            artifactNumToKeepStr: '10'
        ))
        
        // Timeout cho to√†n b·ªô pipeline (30 ph√∫t)
        timeout(time: 30, unit: 'MINUTES')
        
        // Retry logic: retry t·ªëi ƒëa 3 l·∫ßn n·∫øu fail
        retry(3)
        
        // Timestamps trong console output
        timestamps()
        
        // AnsiColor ƒë·ªÉ hi·ªÉn th·ªã m√†u s·∫Øc trong console
        ansiColor('xterm')
        
        // Skip stages n·∫øu kh√¥ng c√≥ thay ƒë·ªïi trong code
        skipStagesAfterUnstable()
        
        // Disable concurrent builds tr√™n c√πng m·ªôt branch
        disableConcurrentBuilds()
    }

    // --------------------------------------------------------------------------
    // 3. ENVIRONMENT VARIABLES
    // --------------------------------------------------------------------------
    // Bi·∫øn m√¥i tr∆∞·ªùng √°p d·ª•ng cho t·∫•t c·∫£ stages
    environment {
        // Application configuration
        APP_NAME = 'bottleneck-resolve'
        APP_VERSION = '0.0.1-SNAPSHOT'
        JAVA_VERSION = '21'
        
        // Maven configuration
        MAVEN_OPTS = '-Dmaven.test.skip=false -Dmaven.javadoc.skip=true'
        MAVEN_CLI_OPTS = '--batch-mode --errors --fail-at-end --show-version'
        
        // Docker configuration
        DOCKER_REGISTRY = credentials('docker-registry-url')  // T·ª´ Jenkins credentials
        DOCKER_IMAGE_NAME = "${DOCKER_REGISTRY}/${APP_NAME}"
        DOCKER_IMAGE_TAG = "${DOCKER_IMAGE_NAME}:${env.BUILD_NUMBER}"
        DOCKER_IMAGE_LATEST = "${DOCKER_IMAGE_NAME}:latest"
        
        // Kubernetes configuration
        K8S_NAMESPACE_STAGING = 'bottleneck-resolve-staging'
        K8S_NAMESPACE_PROD = 'bottleneck-resolve-prod'
        
        // SonarQube configuration (n·∫øu c√≥)
        SONAR_TOKEN = credentials('sonar-token')  // T·ª´ Jenkins credentials
        
        // Notification
        SLACK_WEBHOOK_URL = credentials('slack-webhook-url')  // Optional
    }

    // --------------------------------------------------------------------------
    // 4. PARAMETERS - Pipeline parameters
    // --------------------------------------------------------------------------
    // Cho ph√©p user input khi trigger pipeline manually
    parameters {
        choice(
            name: 'DEPLOY_ENV',
            choices: ['none', 'staging', 'production'],
            description: 'Environment to deploy to'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Skip running tests'
        )
        booleanParam(
            name: 'SKIP_SECURITY_SCAN',
            defaultValue: false,
            description: 'Skip security scanning'
        )
        string(
            name: 'CUSTOM_IMAGE_TAG',
            defaultValue: '',
            description: 'Custom Docker image tag (optional)'
        )
    }

    // --------------------------------------------------------------------------
    // 5. STAGES - Pipeline stages
    // --------------------------------------------------------------------------
    stages {
        // ----------------------------------------------------------------------
        // Stage 1: Checkout Source Code
        // ----------------------------------------------------------------------
        stage('Checkout') {
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Checkout Source Code"
                    echo "=========================================="
                    echo "Branch: ${env.BRANCH_NAME}"
                    echo "Commit: ${env.GIT_COMMIT}"
                    echo "Build Number: ${env.BUILD_NUMBER}"
                }
                // Checkout code t·ª´ SCM
                checkout scm
                
                // Hi·ªÉn th·ªã th√¥ng tin git
                sh '''
                    echo "Git Information:"
                    git log -1 --pretty=format:"%h - %an, %ar : %s"
                    echo ""
                    git show --stat
                '''
            }
        }

        // ----------------------------------------------------------------------
        // Stage 2: Validate Code
        // ----------------------------------------------------------------------
        stage('Validate') {
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Validate Code"
                    echo "=========================================="
                }
                // Validate pom.xml
                sh "mvn ${MAVEN_CLI_OPTS} validate"
                
                // Compile ƒë·ªÉ ki·ªÉm tra syntax errors
                sh "mvn ${MAVEN_CLI_OPTS} compile"
                
                // Checkstyle (n·∫øu c√≥ plugin)
                sh "mvn ${MAVEN_CLI_OPTS} checkstyle:check || true"
            }
            post {
                always {
                    // Archive checkstyle reports
                    archiveArtifacts artifacts: 'target/checkstyle-result.xml', allowEmptyArchive: true
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 3: Build Application
        // ----------------------------------------------------------------------
        stage('Build') {
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Build Application"
                    echo "=========================================="
                }
                // Clean v√† build JAR file
                sh """
                    mvn ${MAVEN_CLI_OPTS} clean package \
                        -DskipTests=${params.SKIP_TESTS}
                """
                
                // Verify JAR file ƒë∆∞·ª£c t·∫°o
                sh """
                    echo "Build artifacts:"
                    ls -lh target/*.jar
                    echo ""
                    echo "JAR contents (first 20 entries):"
                    jar tf target/${APP_NAME}-${APP_VERSION}.jar | head -20
                """
            }
            post {
                success {
                    echo "‚úÖ Build th√†nh c√¥ng!"
                }
                failure {
                    echo "‚ùå Build th·∫•t b·∫°i!"
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 4: Unit Tests
        // ----------------------------------------------------------------------
        stage('Unit Tests') {
            when {
                // Ch·ªâ ch·∫°y n·∫øu kh√¥ng skip tests
                not { params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Unit Tests"
                    echo "=========================================="
                }
                // Ch·∫°y unit tests
                sh "mvn ${MAVEN_CLI_OPTS} test"
            }
            post {
                always {
                    // Publish JUnit test reports
                    junit 'target/surefire-reports/TEST-*.xml'
                    
                    // Archive test reports
                    archiveArtifacts artifacts: 'target/surefire-reports/**/*', allowEmptyArchive: true
                }
                success {
                    echo "‚úÖ T·∫•t c·∫£ unit tests passed!"
                }
                failure {
                    echo "‚ùå M·ªôt s·ªë unit tests failed!"
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 5: Integration Tests
        // ----------------------------------------------------------------------
        stage('Integration Tests') {
            when {
                // Ch·ªâ ch·∫°y tr√™n main branch ho·∫∑c khi c√≥ thay ƒë·ªïi trong src/
                anyOf {
                    branch 'main'
                    changeset "src/**/*"
                }
                not { params.SKIP_TESTS }
            }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21-jammy'
                    args '-v /root/.m2:/root/.m2'
                }
            }
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Integration Tests"
                    echo "=========================================="
                }
                // Ch·∫°y integration tests v·ªõi PostgreSQL
                sh """
                    mvn ${MAVEN_CLI_OPTS} verify \
                        -Dspring.profiles.active=test \
                        -Dskip.unit.tests=true
                """
            }
            post {
                always {
                    // Publish integration test reports
                    junit 'target/failsafe-reports/TEST-*.xml'
                    archiveArtifacts artifacts: 'target/failsafe-reports/**/*', allowEmptyArchive: true
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 6: Code Quality (SonarQube)
        // ----------------------------------------------------------------------
        stage('Code Quality') {
            when {
                // Ch·ªâ ch·∫°y tr√™n main branch ho·∫∑c merge requests
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Code Quality Analysis"
                    echo "=========================================="
                }
                // SonarQube analysis (n·∫øu c√≥ SonarQube server)
                withSonarQubeEnv('SonarQube') {
                    sh """
                        mvn ${MAVEN_CLI_OPTS} sonar:sonar \
                            -Dsonar.projectKey=${APP_NAME} \
                            -Dsonar.sources=src \
                            -Dsonar.java.binaries=target/classes
                    """
                }
            }
            post {
                success {
                    // Wait for SonarQube quality gate
                    script {
                        timeout(time: 5, unit: 'MINUTES') {
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                error "Quality Gate failed: ${qg.status}"
                            }
                        }
                    }
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 7: Security Scanning
        // ----------------------------------------------------------------------
        stage('Security Scan') {
            parallel {
                // Dependency vulnerability scan
                stage('Dependency Scan') {
                    when {
                        not { params.SKIP_SECURITY_SCAN }
                    }
                    steps {
                        script {
                            echo "=========================================="
                            echo "Stage: Dependency Vulnerability Scan"
                            echo "=========================================="
                        }
                        // OWASP Dependency Check
                        sh """
                            if [ ! -f dependency-check.sh ]; then
                                curl -sSL https://raw.githubusercontent.com/owasp/dependency-check/main/dependency-check.sh -o dependency-check.sh
                                chmod +x dependency-check.sh
                            fi
                            ./dependency-check.sh \
                                --project ${APP_NAME} \
                                --scan target \
                                --format JSON \
                                --format HTML \
                                --out dependency-check-report
                        """
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'dependency-check-report.*', allowEmptyArchive: true
                            // Publish dependency scan results
                            dependencyCheckPublisher pattern: 'dependency-check-report.json'
                        }
                    }
                }
                
                // SAST (Static Application Security Testing)
                stage('SAST') {
                    when {
                        not { params.SKIP_SECURITY_SCAN }
                    }
                    steps {
                        script {
                            echo "=========================================="
                            echo "Stage: Static Application Security Testing"
                            echo "=========================================="
                        }
                        // SpotBugs security scan
                        sh "mvn ${MAVEN_CLI_OPTS} spotbugs:check || true"
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'target/spotbugsXml.xml', allowEmptyArchive: true
                        }
                    }
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 8: Build Docker Image
        // ----------------------------------------------------------------------
        stage('Build Docker Image') {
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Build Docker Image"
                    echo "=========================================="
                    
                    // X√°c ƒë·ªãnh image tag
                    def imageTag = params.CUSTOM_IMAGE_TAG ?: env.BUILD_NUMBER
                    env.DOCKER_IMAGE_TAG = "${DOCKER_IMAGE_NAME}:${imageTag}"
                    
                    echo "Building Docker image: ${DOCKER_IMAGE_TAG}"
                }
                
                // Login v√†o Docker registry
                withCredentials([usernamePassword(
                    credentialsId: 'docker-registry-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                        echo \"\${DOCKER_PASS}\" | docker login -u \"\${DOCKER_USER}\" --password-stdin ${DOCKER_REGISTRY}
                    """
                }
                
                // Build Docker image
                sh """
                    docker build \
                        --tag ${DOCKER_IMAGE_TAG} \
                        --tag ${DOCKER_IMAGE_LATEST} \
                        --file Dockerfile \
                        .
                """
                
                // Push image l√™n registry
                sh """
                    docker push ${DOCKER_IMAGE_TAG}
                    docker push ${DOCKER_IMAGE_LATEST}
                """
            }
            post {
                success {
                    echo "‚úÖ Docker image built v√† pushed th√†nh c√¥ng!"
                    script {
                        // L∆∞u image tag ƒë·ªÉ d√πng ·ªü deploy stage
                        writeFile file: 'docker-image-tag.txt', text: env.DOCKER_IMAGE_TAG
                        archiveArtifacts artifacts: 'docker-image-tag.txt'
                    }
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 9: Container Security Scan
        // ----------------------------------------------------------------------
        stage('Container Security Scan') {
            when {
                // Ch·ªâ ch·∫°y sau khi build Docker image th√†nh c√¥ng
                expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
                not { params.SKIP_SECURITY_SCAN }
            }
            agent {
                docker {
                    image 'aquasec/trivy:latest'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Container Security Scan"
                    echo "=========================================="
                }
                // Scan Docker image v·ªõi Trivy
                sh """
                    trivy image \
                        --exit-code 0 \
                        --severity HIGH,CRITICAL \
                        --format json \
                        --output trivy-report.json \
                        ${DOCKER_IMAGE_TAG} || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-report.json', allowEmptyArchive: true
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 10: Deploy to Staging
        // ----------------------------------------------------------------------
        stage('Deploy to Staging') {
            when {
                // Ch·ªâ deploy khi:
                // 1. Parameter DEPLOY_ENV = 'staging' ho·∫∑c 'production'
                // 2. Ho·∫∑c branch l√† main/develop
                anyOf {
                    expression { params.DEPLOY_ENV == 'staging' || params.DEPLOY_ENV == 'production' }
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Deploy to Staging"
                    echo "=========================================="
                    
                    // Load Kubernetes credentials
                    withKubeConfig([credentialsId: 'k8s-staging-credentials', serverUrl: '']) {
                        // Update deployment v·ªõi image m·ªõi
                        sh """
                            kubectl set image deployment/${APP_NAME} \
                                app=${DOCKER_IMAGE_TAG} \
                                -n ${K8S_NAMESPACE_STAGING} || true
                            
                            # Ho·∫∑c apply full manifest
                            # kubectl apply -f deploy/ -n ${K8S_NAMESPACE_STAGING}
                            
                            # Ch·ªù rollout ho√†n th√†nh
                            kubectl rollout status deployment/${APP_NAME} \
                                -n ${K8S_NAMESPACE_STAGING} \
                                --timeout=5m
                            
                            # Verify deployment
                            kubectl get pods -n ${K8S_NAMESPACE_STAGING} -l app=${APP_NAME}
                        """
                    }
                }
            }
            post {
                success {
                    echo "‚úÖ Deployed to staging th√†nh c√¥ng!"
                    script {
                        // Update environment URL
                        def stagingUrl = sh(
                            script: "kubectl get ingress ${APP_NAME} -n ${K8S_NAMESPACE_STAGING} -o jsonpath='{.spec.rules[0].host}'",
                            returnStdout: true
                        ).trim()
                        echo "Staging URL: https://${stagingUrl}"
                    }
                }
                failure {
                    echo "‚ùå Deploy to staging th·∫•t b·∫°i!"
                    // Rollback n·∫øu c·∫ßn
                    script {
                        withKubeConfig([credentialsId: 'k8s-staging-credentials', serverUrl: '']) {
                            sh """
                                kubectl rollout undo deployment/${APP_NAME} -n ${K8S_NAMESPACE_STAGING}
                            """
                        }
                    }
                }
            }
        }

        // ----------------------------------------------------------------------
        // Stage 11: Deploy to Production
        // ----------------------------------------------------------------------
        stage('Deploy to Production') {
            when {
                // Ch·ªâ deploy khi:
                // 1. Parameter DEPLOY_ENV = 'production'
                // 2. Ho·∫∑c c√≥ tag (release)
                anyOf {
                    expression { params.DEPLOY_ENV == 'production' }
                    tag pattern: "v\\d+\\.\\d+\\.\\d+", comparator: "REGEXP"
                }
            }
            steps {
                script {
                    echo "=========================================="
                    echo "Stage: Deploy to Production"
                    echo "=========================================="
                    echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT - C·∫ßn approval!"
                }
                
                // Manual approval step
                input message: 'X√°c nh·∫≠n deploy l√™n Production?', ok: 'Deploy'
                
                // Deploy to production
                withKubeConfig([credentialsId: 'k8s-prod-credentials', serverUrl: '']) {
                    sh """
                        kubectl set image deployment/${APP_NAME} \
                            app=${DOCKER_IMAGE_TAG} \
                            -n ${K8S_NAMESPACE_PROD}
                        
                        kubectl rollout status deployment/${APP_NAME} \
                            -n ${K8S_NAMESPACE_PROD} \
                            --timeout=10m
                        
                        kubectl get pods -n ${K8S_NAMESPACE_PROD} -l app=${APP_NAME}
                    """
                }
            }
            post {
                success {
                    echo "‚úÖ Deployed to production th√†nh c√¥ng!"
                }
                failure {
                    echo "‚ùå Deploy to production th·∫•t b·∫°i!"
                    script {
                        // Auto rollback on failure
                        withKubeConfig([credentialsId: 'k8s-prod-credentials', serverUrl: '']) {
                            sh """
                                kubectl rollout undo deployment/${APP_NAME} -n ${K8S_NAMESPACE_PROD}
                            """
                        }
                    }
                }
            }
        }
    }

    // --------------------------------------------------------------------------
    // 6. POST ACTIONS - Ch·∫°y sau khi pipeline ho√†n th√†nh
    // --------------------------------------------------------------------------
    post {
        // Lu√¥n ch·∫°y (d√π success hay failure)
        always {
            script {
                echo "=========================================="
                echo "Pipeline Summary"
                echo "=========================================="
                echo "Build Number: ${env.BUILD_NUMBER}"
                echo "Build Status: ${currentBuild.currentResult}"
                echo "Duration: ${currentBuild.durationString}"
                echo "=========================================="
            }
            
            // Cleanup workspace
            cleanWs()
        }
        
        // Ch·ªâ ch·∫°y khi th√†nh c√¥ng
        success {
            echo "‚úÖ Pipeline th√†nh c√¥ng!"
            script {
                // Send success notification
                if (env.SLACK_WEBHOOK_URL) {
                    sh """
                        curl -X POST ${SLACK_WEBHOOK_URL} \
                            -H 'Content-Type: application/json' \
                            -d '{
                                "text": "‚úÖ Pipeline #${env.BUILD_NUMBER} th√†nh c√¥ng tr√™n branch ${env.BRANCH_NAME}",
                                "attachments": [{
                                    "color": "good",
                                    "fields": [{
                                        "title": "Build",
                                        "value": "${env.BUILD_NUMBER}",
                                        "short": true
                                    }, {
                                        "title": "Branch",
                                        "value": "${env.BRANCH_NAME}",
                                        "short": true
                                    }]
                                }]
                            }'
                    """
                }
            }
        }
        
        // Ch·ªâ ch·∫°y khi th·∫•t b·∫°i
        failure {
            echo "‚ùå Pipeline th·∫•t b·∫°i!"
            script {
                // Send failure notification
                if (env.SLACK_WEBHOOK_URL) {
                    sh """
                        curl -X POST ${SLACK_WEBHOOK_URL} \
                            -H 'Content-Type: application/json' \
                            -d '{
                                "text": "‚ö†Ô∏è Pipeline #${env.BUILD_NUMBER} th·∫•t b·∫°i tr√™n branch ${env.BRANCH_NAME}",
                                "attachments": [{
                                    "color": "danger",
                                    "fields": [{
                                        "title": "Build",
                                        "value": "${env.BUILD_NUMBER}",
                                        "short": true
                                    }, {
                                        "title": "Branch",
                                        "value": "${env.BRANCH_NAME}",
                                        "short": true
                                    }]
                                }]
                            }'
                    """
                }
            }
        }
        
        // Ch·∫°y khi unstable (c√≥ tests fail nh∆∞ng kh√¥ng block pipeline)
        unstable {
            echo "‚ö†Ô∏è Pipeline unstable - m·ªôt s·ªë tests failed"
        }
        
        // Ch·∫°y khi cleanup (sau t·∫•t c·∫£ post actions)
        cleanup {
            echo "üßπ Cleaning up..."
        }
    }
}

// ==============================================================================
// K·∫æT TH√öC FILE CONFIGURATION
// ==============================================================================
//
// C√ÅCH S·ª¨ D·ª§NG:
// 1. Copy file n√†y v√†o root c·ªßa project v·ªõi t√™n Jenkinsfile
// 2. C·∫•u h√¨nh Jenkins credentials trong Jenkins UI:
//    - docker-registry-url (Secret text)
//    - docker-registry-credentials (Username/Password)
//    - k8s-staging-credentials (Kubernetes config)
//    - k8s-prod-credentials (Kubernetes config)
//    - sonar-token (Secret text) - Optional
//    - slack-webhook-url (Secret text) - Optional
// 3. C√†i ƒë·∫∑t c√°c Jenkins plugins c·∫ßn thi·∫øt:
//    - Docker Pipeline
//    - Kubernetes Plugin
//    - SonarQube Scanner
//    - OWASP Dependency Check
//    - AnsiColor
//    - Timestamper
// 4. T·∫°o Multibranch Pipeline job trong Jenkins
// 5. Point job ƒë·∫øn Git repository
// 6. Jenkins s·∫Ω t·ª± ƒë·ªông detect v√† ch·∫°y pipeline
//
// L∆ØU √ù:
// - Pipeline s·ª≠ d·ª•ng Declarative syntax (khuy·∫øn ngh·ªã)
// - C√≥ th·ªÉ t√πy ch·ªânh theo nhu c·∫ßu c·ª• th·ªÉ
// - Production deployment c·∫ßn manual approval
// - Security scans c√≥ th·ªÉ t·ªën th·ªùi gian
//
// T√ÄI LI·ªÜU THAM KH·∫¢O:
// - https://www.jenkins.io/doc/book/pipeline/syntax/
// - https://www.jenkins.io/doc/book/pipeline/jenkinsfile/
// ==============================================================================
